-*- org -*-

FAILURE means:
  + Exit status: >0
  + Failing target will not be modified (but a tempfile will be created).
  + Failing target's metadata will not be modified.
  + Nota Bene: Successful dependencies will be built even on error.

SUCCESS means:
  + Exit status: 0

Exit status:
  0  = Success.
  1  = Won't overwrite target (anything fixable by --force).
  5  = Build failed (buildscript returned non-zero exit value).
  6  = Failed to write target (even though build succeeded). E.g. target dir
       could not be created, old target (or the target directory) was write
       protected or similar.
  7  = Failed to write metadata.
  10 = Couldn't read buildscript or source (permission denied, or file
       missing, or missing buildscript or source directories).
  15 = Bad options provided.

* VAGUE FUTURE IDEAS
** TODO Garbage collecting of metadata files?
** TODO Handling of circular dependencies
* Early error messages
  Check early error messages (missing files, bad options) are emitted properly.
** DONE 01. Build, missing sourcedir
   Attempt to build target when there is no source dir.

   * FAILURE
     + Exit status: 10
     + Target: not existing
     + Metadata: not existing
     + Tempfile: not existing
** DONE 02. Build, missing scriptdir
   Attempt to build target when there is no script dir.

   * FAILURE
     + Exit status: 10
     + Target: not existing
     + Metadata: not existing
     + Tempfile: not existing
** DONE 03. Build, missing buildscript
   Attempt to build target when there is no buildscript for it.

   * FAILURE
     + Exit status: 10
     + Target: not existing
     + Metadata: not existing
     + Tempfile: not existing
** DONE 04. Build, buildscript missing read bits
   Attempt to build target with buildscript with read bits unset.

   * FAILURE
     + Exit status: 10
     + Target: not existing
     + Metadata: not existing
     + Tempfile: not existing
** DONE 05. Build, buildscript missing execute bits
   Attempt to build target with buildscript with execute bits unset.

   * FAILURE
     + Exit status: 10
     + Target: not existing
     + Metadata: not existing
     + Tempfile: not existing
* One target with no dependencies
  Check buildscript return values, that target and metadata files are only
  updated when they should, and that file timestamps does not affect this.
** DONE 06. Build, buildscript failing
   Attempt to build target with buildscript that returns non-zero exit status.

   * FAILURE
     + Exit status: 5
     + Target: not existing
     + Metadata: not existing
     + Tempfile: existing
** DONE 07. Build, buildscript successful
   Build target with buildscript that returns zero exit status.

   This result in a base setup, with one successfully built target.

   * SUCCESS
     + Exit status: 0
     + Target: existing
     + Metadata: existing
     + Tempfile: not existing
** DONE 08. Rebuild, unmodified
   CLOSED: [2014-07-07 Mon 09:04]
   Rebuild target that has already been built. (Based on 07.)

   * SUCCESS
     + Exit status: 0
     + Target: unmodified
     + Metadata: unmodified
     + Tempfile: not existing
** DONE 09. Rebuild, target time in past
   CLOSED: [2014-07-08 Tue 08:44]
   Rebuild target that has already been built after target file's timestamp
   have been moved into the past. (Based on 07.)

   Target timestamp is set to: 2000-01-01

   * SUCCESS
     + Exit status: 0
     + Target: unmodified
     + Metadata: unmodified
     + Tempfile: not existing
** DONE 10. Rebuild, target time in future
   CLOSED: [2014-07-08 Tue 08:44]
   Rebuild target that has already been built after target file's timestamp
   have been moved into the future. (Based on 07.)

   Target timestamp is set to: 2030-01-01

   * SUCCESS
     + Exit status: 0
     + Target: unmodified
     + Metadata: unmodified
     + Tempfile: not existing
** DONE 11. Rebuild, buildscript time in past
   CLOSED: [2014-07-08 Tue 14:13]
   Rebuild target that has already been built after target's buildscript's
   timestamp have been moved into the past. (Based on 07.)

   Target timestamp is set to: 2000-01-01

   * SUCCESS
     + Exit status: 0
     + Target: unmodified
     + Metadata: unmodified
     + Tempfile: not existing
** DONE 12. Rebuild, buildscript time in future
   CLOSED: [2014-07-08 Tue 14:29]
   Rebuild target that has already been built after target's buildscript's
   timestamp have been moved into the future. (Based on 07.)

   Target timestamp is set to: 2030-01-01

   * SUCCESS
     + Exit status: 0
     + Target: unmodified
     + Metadata: unmodified
     + Tempfile: not existing
** DONE 13. Rebuild, metadata time in past
   CLOSED: [2014-07-09 Wed 09:12]
   Rebuild target that has already been built after target's metadata file's
   timestamp have been moved into the past. (Based on 07.)

   Target timestamp is set to: 2000-01-01

   * SUCCESS
     + Exit status: 0
     + Target: unmodified
     + Metadata: unmodified
     + Tempfile: not existing
** DONE 14. Rebuild, metadata time in future
   CLOSED: [2014-07-09 Wed 09:11]
   Rebuild target that has already been built after target's metadata file's
   timestamp have been moved into the future. (Based on 07.)

   Target timestamp is set to: 2030-01-01

   * SUCCESS
     + Exit status: 0
     + Target: unmodified
     + Metadata: unmodified
     + Tempfile: not existing
** DONE 15. Rebuild, buildscript same output
   CLOSED: [2014-07-11 Fri 17:15]
   Rebuild target after buildscript modified (by a comment or similar) in such
   a way that it still produces the same output as it previously did. (Based on
   07.)

   FIXME: TODO test - Metadata should be updated to contain buildscript checksum

   * SUCCESS
     + Exit status: 0
     + Target: unmodified
     + Metadata: unmodified
     + Tempfile: not existing
** DONE 16. Rebuild, buildscript failing
   CLOSED: [2014-07-11 Fri 17:32]
   Rebuild target after buildscript have been changed so that it now fails.
   (Based on 07.)

   * SUCCESS
     + Exit status: 5
     + Target: unmodified
     + Metadata: unmodified
     + Tempfile: existing
** DONE 17. Rebuild, buildscript new output
   CLOSED: [2014-07-11 Fri 17:23]
   Rebuild target after buildscript have been changed so that it outputs
   something new. (Based on 07.)

   * SUCCESS
     + Exit status: 0
     + Target: modified
     + Metadata: modified
     + Tempfile: not existing
** DONE 18. Rebuild, target modified
   CLOSED: [2014-07-11 Fri 17:46]
   Attempt to rebuild target when previous target exist and is modified. (Based
   on 07.)

   * FAILURE
     + Exit status: 1
     + Target: unmodified
     + Metadata: unmodified
     + Tempfile: existing

** TODO ##. Rebuild, target modified but time same
   Attempt to rebuild target when previous target exist and is modified, but
   its timestamp remains unchanged. (Based on 07.)

   FIXME: Preferably its entire stat fingerprint should be the same, i.e. the
   filesize should remain the same (and its inode number?).

   * FAILURE
     + Exit status: 1
     + Target: unmodified
     + Metadata: unmodified
     + Tempfile: existing
** DONE 19. Rebuild, buildscript+target modified but same
   CLOSED: [2014-07-11 Fri 19:40]
   Rebuild target when previous target exist and is modified, but buildscript
   is also modified and builds a target identical to modified the modified one.

   * SUCCESS
     + Exit status: 0
     + Target: unmodified
     + Metadata: modified
     + Tempfile: not existing
** TODO 20. Rebuild, buildscript modified
** TODO 20. Rebuild, buildscript modified but time same
* Lockfile-related stuff
  Check that lockfile is cleared on non-normal termination. And that it works
  to avert parallel execution of fix.
** DONE xx-run-two-simultaneous-instances-of-fix
   Attempt to run two copies of fix at once. First instance should build,
   second instance should detect lockfile and refuse to start.

   * 1st instance: SUCCESS
     + Exit status: 0
     + Target: existing
     + Metadata modified.
     + Tempfile: not existing

   * 2nd instance: FAILURE
     + Exit status: 8
     + Target: not existing
     + Tempfile: not existing
** TODO Receiving Ctrl-C (SIGTERM)
   Send ctrl-c (SIGINT) to fix as its building and see that it returns correct
   exit code and clears its lockfile.

   This signal should be sent to fix's process group by means of a negative PID
   (in order to kill all subprocesses).

   * FAILURE
     + Exit status: 130 (128 + 2 = INT)
     + No lockfile exists.
** TODO Normal kill (SIGINT)
   Send SIGTERM to fix as its building and see that it returns correct exit
   code and clears its lockfile.

   This signal should be sent to fix's process group by means of a negative PID
   (in order to kill all subprocesses).

   * FAILURE
     + Exit status: 143 (128 + 15 = TERM)
     + No lockfile exists.
** TODO Terminal hangup (SIGHUP)
   Send SIGHUP to fix as its building and see that it returns correct exit code
   and clears its lockfile.

   This signal should be sent to fix's process group by means of a negative PID
   (in order to kill all subprocesses).

   * FAILURE
     + Exit status: 129 (128 + 1 = HUP)
     + No lockfile exists.
* Automatic buildscript dependency
  Checks to see that the automatically added dependency on the buildscript
  works as it should.
* Source dependency
** TODO Build, missing sourcedep
   Attempt to build a target for which there is a missing source dependency.
** TODO Build, sourcedep missing read bits
   Attempt to build target with source dependency with read bits unset.
** TODO Build, sourcedep
   Build target with source dependency.

   The target should include the source dependency, and checks should see that
   it's included.
** TODO Rebuild, sourcedep unmodified
   Rebuild target with source dependency that has already been built.
** TODO Rebuild, sourcedep time in past
   Rebuild target with source dependency that has already been built after the
   source dependency file's timestamp have been moved into the past.

   Source dependency timestamp is set to: 2000-01-01
** TODO Rebuild, sourcedep time in future
   Rebuild target with source dependency that has already been built after
   source dependency file's timestamp have been moved into the future. (Based
   on 07.)

   Source dependency timestamp is set to: 2030-01-01
** TODO Rebuild, sourcedep modified
** TODO Rebuild, sourcedep modified but time same
* Target dependency
** TODO Build target with one dependency
   Build target A with dependency B
   * SUCCESS
     + Exit status: 0
     + Both targets created.
     + Both metadata files created.
** TODO Rebuild target with one dependency
  * SUCCESS
    + Exit status: 0
    + Neither target modified.
    + Neither metadata file modified.
** TODO Rebuild target with modified dependency
** TODO Rebuild target with erased metadata and modified buildscript
   Attempt to rebuild target when previous target exist but have no metadata
   stored, and the newly built target differs from the old target.

   * FAILURE
     + Exit status: 1
** TODO Rebuild target with erased metadata
   Rebuild target when previous target exist but have no metadata stored, and
   the newly built target is the same as the old target.

   * SUCCESS
     + Exit status: 0
* 'default.fix' target dependency
** TODO Build using default buildscript ('default.fix')
   Build target using default.fix.
** TODO Build using default buildscript in parent dir
   Build target using '../default.fix'.
** TODO Rebuild target built by default buildscript, now by target
   Rebuild target that was previously build by default.fix, with a new
   TARGET.fix.
* [eof]
